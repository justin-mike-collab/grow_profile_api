$schema: "https://stage0/schemas/process.schema.yaml"
$id: "https://stage0/template-configurator-api/process.yaml"
title: Process file for a MongoDB configurator API template
version: "1.0"

environment:
  SERVICE_NAME: Service name from architecture.yaml

context:
  - key: info
    type: path
    path: specifications.product.info
  - key: org
    type: path
    path: specifications.product.organization
  - key: dictionaries
    type: path
    path: specifications.catalog.data_dictionaries
  - key: architecture
    type: path
    path: specifications.architecture.architecture
  - key: service
    type: selector
    path: architecture.domains
    filter:
      property: name
      value: "{{ SERVICE_NAME }}"
  - key: repo
    type: selector
    path: service.repos
    filter:
      property: type
      value: "api"

requires:
  - info.name
  - info.slug
  - org.name
  - org.email
  - dictionaries   
  - architecture.domains
  - service.name
  - service.data_domains.controls
  - service.data_domains.creates
  - service.data_domains.consumes
  - repo.name
  - repo.port
  - repo.type

templates:
  # Root Folder templates
  - path: "./LICENSE"
    merge: true
  - path: "./README.md.template"
    output: "./README.md"
    merge: true
  - path: "./Makefile"
    output: "/dev/null"
    merge: true
  - path: "./Pipfile.template"
    output: "./Pipfile"
    merge: true
  - path: "./pytest.ini.template"
    output: "./pytest.ini"
    merge: true
  - path: "./Dockerfile"
    merge: true

  # GitHub Workflow, OpenAPI, and Server files
  - path: "./.github/workflows/docker-push.yml"
    merge: true
  - path: "./docs/openapi.yaml"
    merge: true
  - path: "./src/server.py"
    merge: true

  # Routes for each Controls data domain
  - path: "./src/routes/control_routes.template.py"
    mergeFor:
      items: service.data_domains.controls
      output: "./src/routes/{{item | lower}}_routes.py"

  # Routes for each Creates data domain
  - path: "./src/routes/create_routes.template.py"
    mergeFor:
      items: service.data_domains.creates
      output: "./src/routes/{{item | lower}}_routes.py"

  # Routes for each Consumes data domain
  - path: "./src/routes/consume_routes.template.py"
    mergeFor:
      items: service.data_domains.consumes
      output: "./src/routes/{{item | lower}}_routes.py"

  # Services for each Controls data domain
  - path: "./src/services/control_service.template.py"
    mergeFor:
      items: service.data_domains.controls
      output: "./src/services/{{item | lower}}_service.py"

  # Services for each Creates data domain
  - path: "./src/services/create_service.template.py"
    mergeFor:
      items: service.data_domains.creates
      output: "./src/services/{{item | lower}}_service.py"

  # Services for each Consumes data domain
  - path: "./src/services/consume_service.template.py"
    mergeFor:
      items: service.data_domains.consumes
      output: "./src/services/{{item | lower}}_service.py"

  # Test suite (template for domain-specific route tests)
  - path: "./test/test_server.py"
    merge: true

  # Route unit tests for each data domain
  - path: "./test/routes/test_control_routes.template.py"
    mergeFor:
      items: service.data_domains.controls
      output: "./test/routes/test_{{item | lower}}_routes.py"

  - path: "./test/routes/test_create_routes.template.py"
    mergeFor:
      items: service.data_domains.creates
      output: "./test/routes/test_{{item | lower}}_routes.py"

  - path: "./test/routes/test_consume_routes.template.py"
    mergeFor:
      items: service.data_domains.consumes
      output: "./test/routes/test_{{item | lower}}_routes.py"

  # Service unit tests for each data domain
  - path: "./test/services/test_control_service.template.py"
    mergeFor:
      items: service.data_domains.controls
      output: "./test/services/test_{{item | lower}}_service.py"

  - path: "./test/services/test_create_service.template.py"
    mergeFor:
      items: service.data_domains.creates
      output: "./test/services/test_{{item | lower}}_service.py"

  - path: "./test/services/test_consume_service.template.py"
    mergeFor:
      items: service.data_domains.consumes
      output: "./test/services/test_{{item | lower}}_service.py"

  # E2E tests for each data domain
  - path: "./test/e2e/test_control.template.py"
    mergeFor:
      items: service.data_domains.controls
      output: "./test/e2e/test_{{item | lower}}.py"

  - path: "./test/e2e/test_create.template.py"
    mergeFor:
      items: service.data_domains.creates
      output: "./test/e2e/test_{{item | lower}}.py"

  - path: "./test/e2e/test_consume.template.py"
    mergeFor:
      items: service.data_domains.consumes
      output: "./test/e2e/test_{{item | lower}}.py"
